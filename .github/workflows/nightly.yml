name: Nightly Build

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
  nightly:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Needed for git-cliff

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf libasound2-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend dependencies
        run: npm install

      - name: Download ffmpeg binaries (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
          $binariesDir = "src-tauri/binaries"

          # Create binaries directory if it doesn't exist
          New-Item -ItemType Directory -Path $binariesDir -Force | Out-Null

          Invoke-WebRequest -Uri $ffmpegUrl -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg-temp" -Force

          $extractedFolder = Get-ChildItem -Path "ffmpeg-temp" -Directory | Select-Object -First 1

          Copy-Item -Path "$($extractedFolder.FullName)/bin/ffmpeg.exe" -Destination "$binariesDir/ffmpeg-x86_64-pc-windows-msvc.exe"
          Copy-Item -Path "$($extractedFolder.FullName)/bin/ffprobe.exe" -Destination "$binariesDir/ffprobe-x86_64-pc-windows-msvc.exe"

          Remove-Item -Path "ffmpeg.zip" -Force
          Remove-Item -Path "ffmpeg-temp" -Recurse -Force
        shell: pwsh

      - name: Bump patch version
        id: version
        run: |
          # Read current version from package.json
          $pkg = Get-Content package.json | ConvertFrom-Json
          $currentVersion = $pkg.version

          # Parse and increment patch version
          $parts = $currentVersion -split '\.'
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2] + 1
          $newVersion = "$major.$minor.$patch"

          echo "CURRENT_VERSION=$currentVersion" >> $env:GITHUB_OUTPUT
          echo "NEW_VERSION=$newVersion" >> $env:GITHUB_OUTPUT
          echo "DISPLAY_VERSION=$newVersion-nightly" >> $env:GITHUB_OUTPUT

          # Update package.json
          $pkg.version = $newVersion
          $pkg | ConvertTo-Json -Depth 10 | Set-Content package.json

          # Update tauri.conf.json
          $tauriConf = Get-Content src-tauri/tauri.conf.json -Raw | ConvertFrom-Json
          $tauriConf.version = $newVersion
          $tauriConf | ConvertTo-Json -Depth 10 | Set-Content src-tauri/tauri.conf.json

          # Update Cargo.toml
          (Get-Content src-tauri/Cargo.toml) -replace '^version = ".*"', "version = `"$newVersion`"" | Set-Content src-tauri/Cargo.toml

          Write-Host "Bumped version: $currentVersion -> $newVersion"
        shell: pwsh

      - name: Generate changelog (since last stable release)
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --unreleased --strip header
        env:
          GITHUB_REPO: ${{ github.repository }}

      - name: Build Nightly
        id: build
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: nightly
          releaseName: "Vibe Music ${{ steps.version.outputs.DISPLAY_VERSION }}"
          releaseBody: |
            üåô **Nightly Build** - Version `${{ steps.version.outputs.NEW_VERSION }}`

            > ‚ö†Ô∏è This is a rolling nightly release with the latest changes from the `dev` branch. Nightly builds may be unstable. For stable releases, switch to the **stable** update channel.

            ### Changelog
            ${{ steps.changelog.outputs.content }}
          releaseDraft: false
          prerelease: true
          includeUpdaterJson: true
          args: --target x86_64-pc-windows-msvc

      - name: Clean old nightly assets
        run: |
          # Get all assets from the nightly release except the ones we just uploaded
          # Note: tauri-action also uploads latest.json but doesn't include it in artifactPaths
          $newAssets = @("latest.json")
          $artifactPaths = '${{ steps.build.outputs.artifactPaths }}'
          if ($artifactPaths) {
            $newAssets += ($artifactPaths | ConvertFrom-Json) | ForEach-Object { [System.IO.Path]::GetFileName($_) }
          }

          $allAssets = gh release view nightly --json assets --jq '.assets[].name' 2>$null
          if ($LASTEXITCODE -eq 0 -and $allAssets) {
            foreach ($asset in $allAssets) {
              # Only delete old assets (not the ones we just uploaded)
              if ($asset -notin $newAssets) {
                Write-Host "Deleting old asset: $asset"
                gh release delete-asset nightly $asset --yes
              } else {
                Write-Host "Keeping new asset: $asset"
              }
            }
            Write-Host "Cleaned old nightly assets"
          } else {
            Write-Host "No existing nightly release or assets to clean"
          }
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release metadata
        run: |
          $title = "Vibe Music ${{ steps.version.outputs.DISPLAY_VERSION }}"
          $body = @"
          üåô **Nightly Build** - Version ``${{ steps.version.outputs.NEW_VERSION }}``

          > ‚ö†Ô∏è This is a rolling nightly release with the latest changes from the ``dev`` branch. Nightly builds may be unstable. For stable releases, switch to the **stable** update channel.

          ### Changelog
          ${{ steps.changelog.outputs.content }}
          "@

          gh release edit nightly --title "$title" --notes "$body"
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit version bump
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add package.json src-tauri/tauri.conf.json src-tauri/Cargo.toml src-tauri/Cargo.lock
          git commit -m "chore: bump version to ${{ steps.version.outputs.NEW_VERSION }} [skip ci]" || echo "No changes to commit"
          git push origin dev
